<html>
    <body>
        Hi There!

        <script>


function oTalk(conn_uri, user_uri, session) {
    this.conn = {
        websocket: conn_uri,
        user: user_uri,
        session: session
    };

    this.qid = 0;


    this.queries = {};


}

(function () {

    this.query = function (stanza, cb) {
        this.qid++;
        this.queries[this.qid] = cb;
        stanza.query.id = this.qid;
        console.log("SEND:", stanza);
        this.ws.send(JSON.stringify(stanza));
    };

    this.bind = function (cb) {
        this.query(
            {from: this.conn.user, to: "andyet.net", query: {
                    ns: "http://otalk.com/p/bind",
                    bind: this.conn.user + "/sess/" + this.conn.session,
                }
            }, cb
        );
    };

    this.connect = function (cb) {
        this.ws = new WebSocket(this.conn.websocket);

        this.ws.onmessage = function (msg) {
            console.log("RECV:", msg.data);
            var jmsg = JSON.parse(msg.data);
            if (jmsg.hasOwnProperty('response') && jmsg.response.hasOwnProperty('id') && this.queries.hasOwnProperty(jmsg.response.id)) {
                this.queries[jmsg.response.id].call(this, cb);
                delete this.queries[jmsg.response.id];
            }
        }.bind(this);

        this.ws.onopen = cb;
    };

    this.disconnect = function () {
    };

    this.setPresence = function () {
    };

    this.getRoster = function () {
    };

    this.createChannel = function (channel, config, cb) {
        this.query({to: channel, query: {ns: 'http://otalk.com/p/create', config: {}}}, cb);
    };

    this.subscribe = function (channel, cb) {
        this.query({to: channel, query: {ns: 'http://otalk.com/p/subscribe', }}, cb);
    };

    this.sendMsg = function () {
    };

    this.chat = function (channel, msg) {
        console.log("SEND MSG:", channel, msg);
        this.ws.send(JSON.stringify({to: channel, msg: {ns:'http://otalk.com/p/chat', body: msg}}));
    };

}).call(oTalk.prototype);

var im = new oTalk('ws://localhost:8080/', 'nathan@andyet.net', 'funtimes');

im.connect(function() {
    im.bind(function(reply) {
        console.log("got bind back");
        im.createChannel('nathan@andyet.net/test32', {}, function (reply) {
            console.log("got create back");
            im.subscribe('nathan@andyet.net/test32', function (reply) {
                console.log("got subscribe back");
                im.chat('nathan@andyet.net/test32', 'Hey there!');
            });
        });
    });
});


/*
var ws = new WebSocket("ws://localhost:8080/");

ws.onopen = function() {
    ws.onmessage = function(msg) {
        console.log(JSON.parse(msg.data));
    };
    ws.send(JSON.stringify(
    {from: "nathan@andyet.net", to: "andyet.net", query: {
            ns: "http://otalk.com/p/bind",
            bind: 'nathan@andyet.net/sess/testing'
        }
    }
    ));

    ws.send(JSON.stringify(
    {from: "nathan@andyet.net", to: "nathan@andyet.net/test", query: {
            ns: "http://otalk.com/p/create",
            config: {},
        }
    }
    ));
    
    ws.send(JSON.stringify(
    {from: "nathan@andyet.net", to:"nathan@andyet.net/test", query: {
            ns: "http://otalk.com/p/subscribe",
        }
    }
    ));

    setTimeout(function () {
    
        ws.send(JSON.stringify(
        {from: "nathan@andyet.net", to:"nathan@andyet.net/test", msg: {
                ns: "http://otalk.com/p/chat",
                body: "Hi there!"
            }
        }
        ));
    }, 3000);
};
*/
</script>
    </body>
</html>
